# Murmur Project Specification
# Voice-powered AI scratchpad — whisper to canvas
# Privacy-first, voice-first, credits as fuel
# All user data encrypted at rest — zero plaintext storage

meta:
  name: Murmur
  bundle_id_prefix: com.gudnuf.murmur
  description: "A voice-powered scratchpad that starts as an empty void and grows with you. Speak, and the AI captures, categorizes, and encrypts your thoughts. The app progressively reveals features as you use it — no menus, no onboarding, just a mic and darkness. Tokens fuel the AI — you see them flow in and out. Privacy is ambient, not a toggle."
  author: gudnuf
  philosophy: "WHISPER to CANVAS — start radically simple. The app grows with the user. Features unlock through usage, not menus. The AI and user learn about each other together."
  pillars:
    - "Privacy-first: cypherpunk aesthetic, encryption ambient, lock icon always visible"
    - "Voice-first: speak don't type, mic is the primary interface"
    - "Credits as fuel: tokens power the AI, user sees them flow in and out"

features:
  widget: false          # V1.1 — nail in-app experience first
  icloud_sync: false
  push_notifications: false  # V1.1
  watch_app: false
  live_feed: true        # Ships in V1, locked behind Level 4 progressive unlock
  cashu_payments: true   # V1 must-have — bearer token payments
  apple_pay: true        # V1 must-have — card payments
  subscription: true     # V1 must-have — recurring plan

targets:
  app: Murmur
  tests: MurmurTests

source_dirs:
  app: Murmur

# Progressive Unlock System
# Features appear naturally as the user builds history.
# No gamification — no badges, no confetti. New elements simply appear.
# AI mentions new features conversationally via focus cards.
# Hidden escape hatch: Settings > "Show all features" for power users.
progressive_unlock:
  levels:
    - level: 0
      name: "The Void"
      trigger: "First launch, 0 entries"
      what_appears: "Empty screen. Pulsing mic. Lock icon. Token balance. 'Say anything.' No nav, no chrome."
      screens: [S1, S2, S3, S4, S5]

    - level: 1
      name: "First Light"
      trigger: "1+ entries accepted"
      what_appears: "Focus card on app open. Sparse home with a few cards. Mic moves to floating position."
      screens: [S6, S7]

    - level: 2
      name: "Grid Awakens"
      trigger: "10+ entries, 2+ categories"
      what_appears: "AI composes home layout meaningfully. Widget card variety. Row layouts."
      screens: [S8, S9]

    - level: 3
      name: "Views Emerge"
      trigger: "20+ entries, AI detects patterns"
      what_appears: "AI suggests views via focus card. Bottom nav appears (Home / Views / Settings)."
      screens: [S10, S11]

    - level: 4
      name: "Full Power"
      trigger: "50+ entries OR user opts in via 'Show all features'"
      what_appears: "Live Feed toggle. Backend config. Heat slider. Custom views. Full settings."
      screens: [S12]

  escape_hatch: "Settings > 'Show all features' — immediately unlocks Level 4 for power users"

# Token System
# Tokens are the unit. Users see tokens flowing in (transcript → AI) and out (AI → entries).
# Casual users see a classy counter. Technical users recognize LLM input/output tokens.
# The in/out flow IS the aesthetic — it makes the AI's work visible without being noisy.
tokens:
  unit: "tokens"
  starter_balance: 5000
  display:
    header: "Small pill in app header. Shows remaining balance as a plain number with subtle token icon. Always visible."
    recording: "Hidden during recording (transcription is on-device, free). Appears when processing begins."
    processing: "Two counters appear during AI processing: ↑ (input, fast burst ~0.8s) and ↓ (output, streaming ~3s). Input is the transcript being sent. Output is the structured entries coming back. Monospace, muted, directional arrows in subtle colors."
    confirm: "Session summary in confirm footer: '↑ 247 in · ↓ 312 out' — clean breakdown of what was sent and received."
    settings: "Full breakdown: balance, total in/out lifetime, average per session."
    low_balance: "Amber-tinted number when <500 tokens remaining."
    zero_balance: "Red-tinted + inline message."

  animation_timing:
    input: "Transcript tokens sent in a fast burst. Counter races from 0 to ~200-300 in ~0.8s. Represents the transcript being sent to the LLM in one shot."
    output: "Structured entries stream back. Counter increments from 0 to ~200-400 over ~2-4s. Represents LLM response streaming at ~100 tokens/sec (realistic for Haiku-class models). Items materialize on screen as output tokens arrive."
    visual: "Input arrow (↑) is dimmer, output arrow (↓) is slightly brighter. Numbers use tabular-nums monospace. The flow feels like data moving through a pipe — in fast, out steady."

  typical_session:
    transcript_length: "50-200 words (~75-300 input tokens)"
    ai_response: "Structured entries with categories, summaries, metadata (~200-400 output tokens)"
    total: "~300-700 tokens per capture session"

  costs:
    - action: "On-device transcription"
      tokens: 0
      notes: "Free, Apple Speech. No tokens consumed."
    - action: "AI processing (batch)"
      tokens: "300-700"
      notes: "Per session. ~200 in + ~400 out typical."
    - action: "AI processing (live feed)"
      tokens: "600-1400"
      notes: "~2x batch. Streaming during recording."
    - action: "Home recomposition"
      tokens: "100-300"
      notes: "Background. AI re-selects widget layout."
    - action: "Focus card selection"
      tokens: "50-150"
      notes: "On app open. AI picks what to surface."

  topup_options:
    card:
      method: "Apple Pay"
      tiers:
        - { tokens: 10000, price: "$0.99" }
        - { tokens: 50000, price: "$3.99" }
        - { tokens: 100000, price: "$6.99" }
    cashu:
      method: "Cashu ecash tokens"
      description: "Paste ecash token or scan QR. No account. Bearer tokens. The cypherpunk option."
    subscription:
      method: "Monthly subscription"
      amount: "100,000 tokens/month"
      price: "$4.99/month"
      description: "Auto-renew"

  zero_balance_behavior: "Recording still works (on-device transcription = free). AI processing disabled. Items saved as raw encrypted transcripts. Message: 'Out of tokens. Items saved but not categorized. Top up to unlock AI.'"

  heat_metaphor:
    description: "Visual slider showing cost vs capability tradeoff (Level 4+)"
    tiers:
      - name: "Economy"
        transcription: "On-device"
        processing: "Cloud"
        cost: "Free transcription"
        speed: "Slower"
      - name: "Standard"
        transcription: "Cloud"
        processing: "Cloud"
        cost: "tokens/session"
        speed: "Normal"
      - name: "Live"
        transcription: "Cloud everything"
        processing: "Live Feed ON"
        cost: "tokens x3/session"
        speed: "Instant + magical"

# Privacy & Cypherpunk Aesthetic
privacy:
  lock_icon: "Always visible top-left on every screen. Green dot = all encrypted. Tap → encryption detail."
  encryption_detail: "AES-256-GCM. Key in Secure Enclave. N entries encrypted."
  data_split:
    encrypted:
      - "rawTranscript (always encrypted, only decrypted in memory when viewing)"
      - "processedContent (always encrypted)"
    queryable_plaintext:
      - "summary (for SwiftData queries and widget display)"
      - "category (for filtering)"
      - "tags (for search)"
      - "status, priority, dueDate (for sorting/filtering)"
    tradeoff: "Summaries and metadata are plaintext for query performance. This is explicit and documented. Raw content is always encrypted."
  ai_model_badges:
    - { badge: "[TEE]", meaning: "Trusted Execution Environment — encrypted in transit and at rest on server" }
    - { badge: "[On-Device]", meaning: "Never leaves phone" }
    - { badge: "[Cloud]", meaning: "Encrypted in transit" }

data_models:
  - name: Entry
    description: "The atomic unit — every voice input is immediately interpreted, categorized, and stored as an Entry. Not all entries are 'thoughts' — some are actions, reminders, lists, ideas. The category determines the meaning."
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier"
      - name: rawTranscript
        type: EncryptedString
        required: true
        description: "Original voice-to-text transcription (encrypted at rest via CryptoKit)"
      - name: processedContent
        type: EncryptedString
        required: true
        description: "AI-structured version of the transcript (encrypted at rest). Always populated — processing is synchronous with capture, never deferred."
      - name: category
        type: EntryCategory
        required: true
        description: "AI-assigned immediately on capture. No 'unprocessed' state — the LLM interprets what the user said and categorizes in the same pipeline as transcription."
      - name: status
        type: EntryStatus
        required: true
        default: ".active"
        description: "Lifecycle state: active, completed, archived, snoozed"
      - name: priority
        type: Int?
        required: false
        description: "AI-inferred priority (1=highest, 5=lowest) — assigned during initial processing"
      - name: dueDate
        type: Date?
        required: false
        description: "AI-extracted deadline from natural language (e.g., 'Thursday' → next Thursday)"
      - name: audioDuration
        type: TimeInterval?
        required: false
        description: "Duration of the original voice recording"
      - name: locationContext
        type: String?
        required: false
        description: "Optional location where entry was captured"
      - name: summary
        type: String
        required: true
        description: "Short AI-generated summary for display in widgets and lists (1 line max). Plaintext for query performance."
      - name: creditCost
        type: Int
        required: true
        default: 0
        description: "Total tokens consumed processing this entry (input + output)"
      - name: createdAt
        type: Date
        required: true
        default: "Date()"
        description: "When the entry was captured"
      - name: updatedAt
        type: Date
        required: true
        default: "Date()"
        description: "Last modification timestamp"
    relationships:
      - type: many-to-many
        target: Tag
        description: "Entries can have multiple tags, tags can apply to multiple entries"
      - type: one-to-many
        target: Entry
        description: "Parent-child relationship for grouping related entries (e.g., a grocery list entry with individual items)"

  - name: Tag
    description: "Flexible categorization for entries — AI-generated or user-created"
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier"
      - name: name
        type: String
        required: true
        description: "Tag display name"
      - name: colorHex
        type: String?
        required: false
        description: "Optional hex color for visual distinction"
      - name: isSystemGenerated
        type: Bool
        required: true
        default: false
        description: "Whether this tag was created by the AI agent"
      - name: createdAt
        type: Date
        required: true
        default: "Date()"
        description: "When the tag was created"
    relationships:
      - type: many-to-many
        target: Entry
        description: "Tags can be applied to multiple entries"

  - name: CreditBalance
    description: "Tracks the user's sat balance, spending, and subscription status. Singleton model."
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier (singleton in practice)"
      - name: balance
        type: Int
        required: true
        default: 5000
        description: "Current token balance. Starts at 5,000 (starter tokens)."
      - name: totalSpent
        type: Int
        required: true
        default: 0
        description: "Lifetime tokens consumed by AI operations"
      - name: totalTopUps
        type: Int
        required: true
        default: 0
        description: "Lifetime tokens added via top-ups"
      - name: lastTopUpDate
        type: Date?
        required: false
        description: "When the user last added credits"
      - name: subscriptionActive
        type: Bool
        required: true
        default: false
        description: "Whether the monthly subscription is active"
      - name: subscriptionRenewDate
        type: Date?
        required: false
        description: "Next renewal date for active subscription"
    relationships: []

  - name: UserProgress
    description: "Tracks usage metrics that drive progressive unlock. Singleton model."
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier (singleton in practice)"
      - name: totalEntries
        type: Int
        required: true
        default: 0
        description: "Total entries ever created (not decremented on delete)"
      - name: distinctCategories
        type: Int
        required: true
        default: 0
        description: "Number of unique categories used"
      - name: currentLevel
        type: Int
        required: true
        default: 0
        description: "Current progressive unlock level (0-4)"
      - name: viewsSuggested
        type: Bool
        required: true
        default: false
        description: "Whether the AI has suggested dedicated views"
      - name: viewsAccepted
        type: Bool
        required: true
        default: false
        description: "Whether the user accepted the views suggestion"
      - name: liveFeedUnlocked
        type: Bool
        required: true
        default: false
        description: "Whether Live Feed has been unlocked"
      - name: allFeaturesShown
        type: Bool
        required: true
        default: false
        description: "Whether user manually activated 'Show all features'"
      - name: updatedAt
        type: Date
        required: true
        default: "Date()"
        description: "Last time progress was recalculated"
    relationships: []

  - name: WidgetConfig
    description: "Defines how an in-app widget renders — what to show and how"
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier"
      - name: widgetType
        type: WidgetType
        required: true
        description: "Widget variant: todo, idea, reminder, list, quote, habit, general"
      - name: size
        type: WidgetSize
        required: true
        default: ".medium"
        description: "Widget size: small (1x1), medium (2x1), large (2x2)"
      - name: title
        type: String?
        required: false
        description: "Optional header text for the widget"
      - name: entryFilter
        type: String?
        required: false
        description: "Query string to filter which entries appear in this widget"
      - name: maxItems
        type: Int
        required: true
        default: 3
        description: "Maximum number of items to display"
      - name: isPinned
        type: Bool
        required: true
        default: false
        description: "Whether the user pinned this widget (vs AI-selected)"
      - name: sortOrder
        type: Int
        required: true
        default: 0
        description: "Display order on the home screen"
    relationships: []

  - name: ViewConfig
    description: "A named, navigable view — preconfigured or user-created. Only relevant at Level 3+."
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier"
      - name: name
        type: String
        required: true
        description: "Display name (e.g., 'Todo', 'Ideas', 'Don't Forget')"
      - name: icon
        type: String
        required: true
        description: "SF Symbol name for navigation"
      - name: filterCategory
        type: EntryCategory?
        required: false
        description: "Optional category filter"
      - name: isDefault
        type: Bool
        required: true
        default: false
        description: "Whether this view ships with the app"
      - name: sortOrder
        type: Int
        required: true
        default: 0
        description: "Navigation order"
    relationships: []

  - name: AgentContext
    description: "The AI agent's persistent memory — patterns observed and current recommendations"
    properties:
      - name: id
        type: UUID
        required: true
        default: "UUID()"
        description: "Unique identifier (singleton in practice)"
      - name: updatedAt
        type: Date
        required: true
        default: "Date()"
        description: "Last time the agent updated its context"
      - name: userPatternsJSON
        type: String
        required: true
        default: "'{}'"
        description: "JSON blob of observed user patterns and preferences"
      - name: widgetLayoutJSON
        type: String
        required: true
        default: "'[]'"
        description: "Current AI-recommended widget layout as JSON"
      - name: lastAnalyzedEntryDate
        type: Date?
        required: false
        description: "Timestamp of the most recently analyzed entry"
    relationships: []

enums:
  - name: EntryCategory
    description: "Assigned immediately on capture — no 'unprocessed' state. The LLM determines what the user said and picks the right category."
    cases:
      - todo        # Actionable task: "pick up dry cleaning"
      - idea        # Creative/conceptual: "app that converts receipts to meal plans"
      - reminder    # Time-bound: "DMV appointment Thursday"
      - note        # Informational: "the wifi password is ..."
      - list        # Collection: "grocery list: milk, eggs, bread"
      - habit       # Recurring: "meditate every morning"
      - question    # Something to look up: "what's the capital of Mongolia"
      - thought     # True free-form thought: "I wonder if consciousness is just..."

  - name: EntryStatus
    cases:
      - active
      - completed
      - archived
      - snoozed

  - name: WidgetType
    cases:
      - todo
      - idea
      - reminder
      - list
      - quote
      - habit
      - general

  - name: WidgetSize
    cases:
      - small
      - medium
      - large

  - name: UnlockLevel
    description: "Progressive unlock levels that control what UI elements are visible"
    cases:
      - void          # Level 0: first launch, 0 entries
      - firstLight    # Level 1: 1+ entries
      - gridAwakens   # Level 2: 10+ entries, 2+ categories
      - viewsEmerge   # Level 3: 20+ entries, patterns detected
      - fullPower     # Level 4: 50+ entries or manual opt-in

protocols:
  - name: TranscriberService
    description: "Abstraction for voice-to-text. Apple Speech as reference impl, but designed for any backend (Whisper, Deepgram, etc.)"
    methods:
      - "func startRecording() async throws"
      - "func stopRecording() async throws -> String"
      - "var isRecording: Bool { get }"
      - "var isAvailable: Bool { get }"

  - name: LLMService
    description: "Abstraction for AI processing. No concrete backend yet — mock for development. Designed around OpenAI-compatible chat completion shape for max compatibility."
    methods:
      - "func processEntry(_ rawText: String, context: AgentContext) async throws -> ProcessedEntry"
      - "func composeHomeLayout(entries: [Entry], context: AgentContext) async throws -> [WidgetConfig]"
      - "func selectFocusCard(entries: [Entry], context: AgentContext) async throws -> Entry?"
      - "func chat(messages: [ChatMessage]) async throws -> String"

  - name: EncryptionService
    description: "Handles all data encryption/decryption. CryptoKit-based with Keychain-stored keys."
    methods:
      - "func encrypt(_ plaintext: String) throws -> EncryptedString"
      - "func decrypt(_ encrypted: EncryptedString) throws -> String"
      - "func generateKey() throws -> SymmetricKey"
      - "var isKeyAvailable: Bool { get }"

  - name: CreditService
    description: "Manages credit balance, tracks spending, handles top-ups."
    methods:
      - "func deduct(tokens: Int, for action: String) async throws"
      - "func topUp(tokens: Int, via method: TopUpMethod) async throws"
      - "var balance: Int { get async }"
      - "var isLowBalance: Bool { get }"
      - "func estimateCost(for action: CreditAction) -> Int"

processing_pipeline:
  description: "Voice input is transcribed and processed in a single synchronous pipeline. No entry ever exists in an 'unprocessed' state. Exception: zero-balance users get raw encrypted transcripts without AI processing."
  steps:
    - step: 1
      name: "Capture"
      description: "User taps mic, speaks, taps to stop. Audio streamed to TranscriberService."
    - step: 2
      name: "Transcribe"
      description: "TranscriberService converts speech to raw text. Can provide real-time partial results during recording. On-device transcription is free."
    - step: 3
      name: "Credit Check"
      description: "Check if user has sufficient credits for AI processing. If zero balance, skip to step 5 with raw transcript only."
    - step: 4
      name: "Interpret"
      description: "LLMService.processEntry() receives raw text. Determines category, extracts structured data (due dates, list items, action items), generates summary, assigns priority. Credits deducted. This is NOT deferred — it runs immediately after transcription."
    - step: 5
      name: "Encrypt & Persist"
      description: "EncryptionService encrypts rawTranscript and processedContent. Entry saved to SwiftData with all fields populated. creditCost recorded."
    - step: 6
      name: "Recompose"
      description: "Home screen widget layout is refreshed to potentially include the new entry."

  live_feed_mode:
    description: "Level 4+ alternative pipeline. Items materialize during recording — no processing wait."
    cost_multiplier: "~2x batch processing"
    behavior: "AS YOU SPEAK: items appear at bottom of recording overlay. On stop, items already present — smooth transition to confirm screen. Feels instant and magical."

security:
  description: "All user content encrypted at rest. Summaries and metadata are plaintext for query performance — this tradeoff is explicit."
  layers:
    - name: "iOS Data Protection"
      description: "NSFileProtectionComplete on the SwiftData SQLite store. OS encrypts the entire database file when device is locked."
      scope: "Entire database"

    - name: "Application-Level Encryption"
      description: "CryptoKit AES-GCM encryption for sensitive Entry fields (rawTranscript, processedContent). Even if the DB file is extracted, content is encrypted with an app-specific key."
      scope: "Entry.rawTranscript, Entry.processedContent"
      implementation: "EncryptedString type wrapping CryptoKit sealed box. Key stored in Keychain with kSecAttrAccessibleWhenUnlockedThisDeviceOnly."

    - name: "Keychain for Credentials"
      description: "All API keys, tokens, and encryption keys stored in iOS Keychain. Never in UserDefaults, never in plaintext files."
      scope: "API keys, encryption symmetric key, any auth tokens"

    - name: "Memory Hygiene"
      description: "Decrypted content held in memory only while displayed. Cleared when views disappear. No logging of decrypted content."
      scope: "Runtime"

  encrypted_types:
    - name: EncryptedString
      description: "Custom type wrapping Data (CryptoKit AES-GCM sealed box). Conforms to Codable for SwiftData storage. Transparent encrypt/decrypt via EncryptionService."

shared_sources:
  - Models/Entry.swift
  - Models/Tag.swift
  - Models/CreditBalance.swift
  - Models/UserProgress.swift
  - Models/WidgetConfig.swift
  - Models/Enums.swift
  - Config/PersistenceConfig.swift
  - Config/Theme.swift
  - Services/EncryptionService.swift
  - Services/CreditService.swift

tech_stack:
  ui: SwiftUI
  persistence: SwiftData
  min_ios: "17.0"
  swift_version: "5.9"
  min_xcode: 26

build_config:
  simulator_device: "iPhone 16"
  default_branch: main

decisions:
  - decision: "UI Framework"
    choice: "SwiftUI"
    rationale: "Declarative composition is essential for dynamic widget-based layouts. Native support for animations, gestures, and progressive UI reveals."

  - decision: "Persistence"
    choice: "SwiftData + CryptoKit encryption"
    rationale: "Type-safe, integrates with SwiftUI observation, handles relationships (Entry<->Tag). Requires iOS 17+ which is acceptable. All user content encrypted at rest via CryptoKit AES-GCM with Keychain-stored keys."

  - decision: "Voice Input"
    choice: "Protocol-abstracted (Apple Speech reference impl)"
    rationale: "Apple Speech framework is free, on-device, and good enough for MVP. TranscriberService protocol allows swapping to Whisper/Deepgram later. On-device transcription costs zero credits."

  - decision: "LLM Integration"
    choice: "Protocol-abstracted (mock for development)"
    rationale: "LLMService protocol with OpenAI-compatible chat shape. No concrete backend yet — uses mock that returns deterministic results for UI development. Designed for open standards compatibility."

  - decision: "Progressive Disclosure"
    choice: "5-level progressive unlock driven by usage metrics"
    rationale: "The app starts as a void — just a mic and darkness. Features appear as the user builds history. This eliminates onboarding friction, prevents feature overwhelm, and creates a sense of the app growing with you. No gamification — elements simply appear. AI mentions new features via focus cards."

  - decision: "Credit System"
    choice: "Tokens as credit unit with visible in/out flow and 3 top-up methods"
    rationale: "Tokens are the natural unit — they map directly to what the AI consumes. Users see tokens flow in (transcript sent) and out (entries received). Three top-up methods: Apple Pay (convenience), Cashu ecash tokens (cypherpunk privacy), and monthly subscription (predictability). Starter balance of 5,000 tokens lets users try before paying. Zero balance degrades gracefully — recording still works, AI processing disabled."

  - decision: "Live Feed"
    choice: "Ships in V1, locked behind Level 4 progressive unlock"
    rationale: "Items materialize during recording — no processing wait. Costs ~2x batch but feels instant and magical. Locked to Level 4 because it's expensive and users need to understand the credit system first."

  - decision: "Cashu Payments"
    choice: "V1 must-have, paste or scan QR"
    rationale: "Bearer token payments with no account required. Aligns with cypherpunk privacy ethos. User pastes an ecash token URL or scans a QR code. No identity attached to the payment."

  - decision: "WidgetKit"
    choice: "Deferred to V1.1"
    rationale: "Nail the in-app experience first. WidgetKit adds complexity (App Groups, shared containers, Keychain access groups). Ship V1 without it, add in V1.1."

  - decision: "Widget Architecture"
    choice: "Reusable WidgetCard components with AI-driven composition"
    rationale: "All in-app widgets share the same design tokens (Theme.swift) and WidgetCard container. The AI picks which widgets to show. Users can pin favorites."

  - decision: "Home Screen Strategy"
    choice: "Progressive: void → sparse → AI-composed, with bottom nav appearing at Level 3"
    rationale: "Level 0 is a void with a mic. Level 1 adds sparse cards. Level 2 adds AI-composed grid. Level 3 adds bottom nav with Views tab. This progression lets the home screen earn complexity."

  - decision: "Immediate Processing"
    choice: "Synchronous transcribe → interpret → encrypt → persist pipeline"
    rationale: "No entry ever exists in an unprocessed state. The moment the user stops speaking, the transcript is sent to the LLM for categorization, then encrypted and persisted. Exception: zero balance saves raw encrypted transcript without AI processing."

  - decision: "Security"
    choice: "Defense in depth: iOS Data Protection + CryptoKit AES-GCM + Keychain"
    rationale: "User speaks sensitive things — passwords, personal thoughts, financial info. Three layers: OS-level file encryption, app-level field encryption for transcripts, Keychain for all keys and credentials. Summaries are plaintext for query performance — this tradeoff is explicit."

  - decision: "AI Agent State"
    choice: "SwiftData model with JSON blobs"
    rationale: "AgentContext model stores patterns and layout recommendations as JSON. Context-efficient — the LLM only reads/writes what it needs."

  - decision: "Build Tooling"
    choice: "Nix + direnv + XcodeGen"
    rationale: "Reproducible dev environment. XcodeGen eliminates xcodeproj merge conflicts. Direnv auto-activates Nix shell."

  - decision: "Architecture Pattern"
    choice: "MVVM + Service Protocols"
    rationale: "ViewModels consume service protocols (TranscriberService, LLMService, CreditService). Easy to test with mocks, clean separation of concerns."

  - decision: "Open Standards"
    choice: "OpenAI-compatible API shape for LLM protocol"
    rationale: "Most open-source LLM servers (llama.cpp, ollama, vLLM) expose OpenAI-compatible endpoints. Designing the protocol around this shape maximizes backend compatibility."

milestones:
  - name: "M1: Core Pipeline"
    description: "Project scaffold, data models, the void, recording, processing, confirm — the complete capture flow"
    issues:
      - title: "Project scaffold (Nix, XcodeGen, CI, theme, design tokens)"
        description: "Set up the Nix flake, XcodeGen project.yml, Makefile, Theme.swift with design tokens, and CI pipeline."
      - title: "SwiftData models (Entry, Tag, CreditBalance, UserProgress) + encryption"
        description: "Implement all data models with SwiftData. EncryptionService + EncryptedString type with CryptoKit AES-GCM. CreditBalance and UserProgress as singletons."
      - title: "Void state (S1) — the empty app with lock icon + token balance"
        description: "Deep dark screen. Pulsing mic center. Lock icon top-left (tappable → settings). Token balance top-right. 'Say anything.' No nav, no chrome."
      - title: "Recording overlay (S2) — mic states, waveform, live transcript, token counter"
        description: "Full-screen overlay. Active mic with pulse rings. Waveform. Live transcript. Duration counter. Token flow counter (↑ in · ↓ out)."
      - title: "Processing state (S3) — transition animation, item materialization"
        description: "Waveform freezes. Mic → spinner. 'Thinking...' Items materialize one by one with staggered animation."
      - title: "Confirm screen (S4) — item list, accept/discard/correct, session cost"
        description: "Transcript collapsible at top. Extracted items as cards with category badges. Per-item: correct (mic) / discard (X). 'Accept all' button. Token breakdown: '↑ 247 in · ↓ 312 out'."
      - title: "TranscriberService protocol + Apple Speech implementation"
        description: "Protocol abstraction for voice-to-text. Apple Speech as reference implementation. On-device, free, zero credit cost."
      - title: "LLMService protocol + mock implementation"
        description: "Protocol with processEntry, composeHomeLayout, selectFocusCard, chat methods. Mock returns deterministic results for UI development."

  - name: "M2: Home + Focus"
    description: "Sparse home, focus cards, AI-composed home, entry detail, progressive unlock tracking"
    issues:
      - title: "Sparse home (S7) — basic card layout with encrypted entries"
        description: "Level 1 home. 'Murmur' header + greeting. A few cards. Lock icon + token balance in header. Floating mic. No bottom nav."
      - title: "Focus card (S6) — AI selection logic, act/dismiss"
        description: "ONE item centered. Ghost of home behind. Act (complete/explore/dismiss) or tap anywhere for home. Priority: todo due today > reminder 24h > unchecked habit > AI insight > skip."
      - title: "AI-composed home (S8) — rule-based layout with LLM fallback"
        description: "Replaces S7 at Level 2. Dynamic widget grid — reminder cards, todo count, ideas, habits. AI selects layout."
      - title: "Entry detail (S9) — view, action bar, transcript link"
        description: "Category badge, processed content, 'tell me more' AI button, tags, metadata. Action bar: archive/snooze/delete. Transcript link."
      - title: "Progressive unlock tracking (UserProgress)"
        description: "Track totalEntries, distinctCategories, compute currentLevel. Trigger UI reveals when levels change. No notifications — elements simply appear."

  - name: "M3: Credits + Privacy"
    description: "Credit balance display, burn tracking, settings, top-up flow, TEE badges"
    issues:
      - title: "Credit balance display (header, recording, confirm, settings)"
        description: "Show token balance in header (always), ↑↓ flow during processing, in/out breakdown on confirm, full stats in settings. Amber at <500, red at 0."
      - title: "Credit burn tracking during AI calls"
        description: "CreditService.deduct() called during AI operations. Per-entry creditCost recorded. Real-time counter during recording."
      - title: "Settings minimal (S5) — encryption status, credits, model selector"
        description: "Level 0-2 settings: 3 sections. Security (encryption active, key status, entries encrypted), Credits (balance, top up), Processing (AI model with TEE badge, mode)."
      - title: "TEE badges for model selector"
        description: "Model selector shows badges: [TEE] for trusted execution, [On-Device] for local, [Cloud] for standard. Badge colors: TEE=green, On-Device=blue, Cloud=gray."
      - title: "Top-up flow (S12) — Apple Pay, Cashu, Subscribe"
        description: "Three tabs: Card (Apple Pay packs), Cashu (paste ecash token or scan QR), Subscribe (monthly plan). Accessible from Settings > Credits > Top Up."

  - name: "M4: Views + Polish"
    description: "Views suggestion, bottom nav, category views, voice correction, live feed, full settings"
    issues:
      - title: "Views suggestion via focus card (Level 3 unlock)"
        description: "When user has 20+ entries and AI detects patterns, show focus card: 'You have N todos. Want a dedicated view?' Accept → bottom nav appears."
      - title: "Bottom nav appearance"
        description: "3-tab nav: Home / Views / Settings. Only appears at Level 3+. Glass-morphism effect. Animated entrance (slides up)."
      - title: "Views grid (S10) + Category views (S11)"
        description: "Grid of category views (Todo, Ideas, Don't Forget, etc.). Each view is a filtered list with appropriate interactions per category type."
      - title: "Voice correction sub-flow (from confirm)"
        description: "On confirm, tap mic icon on an item. Item expands with original strikethrough. Amber correction zone: small mic + 'Speak your fix'. LLM merges original + correction."
      - title: "Live Feed toggle (Level 4)"
        description: "Toggle in settings (Level 4+). When ON, items materialize during recording — no processing wait. Costs ~2x. Visual: items appear at bottom of recording overlay."
      - title: "Full settings (Level 4)"
        description: "AI backend config (transcription service, LLM endpoint, API key). Heat visualization slider. Manage views. Data export / clear."

# V1 Screen Inventory (12 screens, progressive)
ui_mockups:
  # Always Present (Level 0+)
  - name: "S1: Void"
    file: "mockups/15-void.html"
    level: 0
    description: "Deep dark. Pulsing mic center. Lock icon top-left (tappable → settings). Token balance top-right. 'Say anything.' No nav."

  - name: "S2: Recording"
    file: "mockups/16-recording-credits.html"
    level: 0
    description: "Full-screen overlay. Active mic with pulse rings. Waveform. Live transcript. Duration counter. Token flow counter (↑ in · ↓ out)."

  - name: "S3: Processing"
    file: "mockups/03-voice-capture.html"
    level: 0
    description: "Waveform freezes. Mic → spinner. 'Thinking...' Items materialize one by one with staggered animation."
    notes: "Processing state shown within voice capture mockup"

  - name: "S4: Confirm"
    file: "mockups/17-confirm-credits.html"
    level: 0
    description: "Transcript collapsible at top. Extracted items as cards with category badges. Per-item: correct (mic) / discard (X). 'Accept all' button. Token breakdown: '↑ 247 in · ↓ 312 out'."

  - name: "S5: Settings (minimal)"
    file: "mockups/18-settings-minimal.html"
    level: 0
    description: "Progressive — starts as 3 sections (Encryption / Credits / Processing Mode), grows to full config at Level 4. Entry via lock icon (Level 0-2) or Settings tab (Level 3+)."

  # Level 1+ (1-5 entries)
  - name: "S6: Focus Card"
    file: "mockups/09-focus-todo.html"
    level: 1
    description: "ONE item centered. Ghost of home behind. Act (complete/explore/dismiss) or tap anywhere for home."

  - name: "S7: Home (Sparse)"
    file: "mockups/21-home-sparse.html"
    level: 1
    description: "'Murmur' header + greeting. A few cards. Lock icon + token balance in header. Floating mic. No bottom nav yet."

  # Level 2+ (10+ entries)
  - name: "S8: Home (AI-Composed)"
    file: "mockups/01-home-ai.html"
    level: 2
    description: "Replaces S7. Dynamic widget grid — reminder cards, todo count, ideas, habits. AI selects layout."

  - name: "S9: Entry Detail"
    file: "mockups/06-thought-detail.html"
    level: 2
    description: "Category badge, processed content, 'tell me more' AI button, tags, metadata. Action bar: archive/snooze/delete. Transcript link."

  # Level 3+ (20+ entries, patterns detected)
  - name: "S10: Views"
    file: "mockups/04-pinned-views.html"
    level: 3
    description: "Grid of category views (Todo, Ideas, Don't Forget, etc.). Appears when bottom nav unlocks."

  - name: "S11: Category View"
    file: "mockups/05-todo-view.html"
    level: 3
    description: "Filtered list (e.g., Todo view with checkboxes, filter chips)."

  - name: "S12: Credits / Top-Up"
    file: "mockups/19-topup.html"
    level: 4
    description: "Balance, usage, top-up: Card (Apple Pay) / Cashu tokens (paste or scan QR) / Subscription."

  # Additional mockups (not in 12-screen inventory but useful)
  - name: "Recording: Live Feed"
    file: "mockups/20-recording-live.html"
    level: 4
    description: "Live Feed ON: items materializing during recording. No processing wait."

  - name: "Focus: Insight"
    file: "mockups/10-focus-insight.html"
    level: 1
    description: "LLM resurfaces an older idea as a focus card."

  - name: "Focus: Dismissed"
    file: "mockups/11-focus-dismissed.html"
    level: 1
    description: "After dismissing focus card, reveals the home behind."

  - name: "Confirm: Cards"
    file: "mockups/12-confirm-single.html"
    level: 0
    description: "One-at-a-time card review variant of confirm flow."

  - name: "Voice Correction"
    file: "mockups/14-confirm-edit.html"
    level: 0
    description: "Re-record to fix an item during confirm."

  - name: "Entry Detail: Expanded"
    file: "mockups/06b-thought-detail-expanded.html"
    level: 2
    description: "Full content view of entry detail."

  - name: "Entry Detail: Transcript"
    file: "mockups/06c-thought-transcript.html"
    level: 2
    description: "Original recording transcript view."

  - name: "iOS Widget (V1.1)"
    file: "mockups/07-ios-widget.html"
    level: null
    description: "WidgetKit home screen widget — deferred to V1.1."

  - name: "Home: Empty State (legacy)"
    file: "mockups/02-home-empty.html"
    level: null
    description: "Original empty state — replaced by Void (S1) in V1 revision."

  - name: "Settings (legacy)"
    file: "mockups/08-settings.html"
    level: null
    description: "Original full settings — replaced by progressive settings in V1 revision."
